var f=Object.defineProperty;var p=(n,e,s)=>e in n?f(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var o=(n,e,s)=>(p(n,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))i(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function s(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerpolicy&&(a.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?a.credentials="include":t.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(t){if(t.ep)return;t.ep=!0;const a=s(t);fetch(t.href,a)}})();var l=(n=>(n[n.active=1]="active",n[n.pause=2]="pause",n[n.game_over=3]="game_over",n[n.new=4]="new",n))(l||{});const m="TETRIS_SCORE",r={play:"play",resume:"resume",restart:"restart",score:"score",settings:"settings",close:"close"},v={[r.play]:"\u041D\u0430\u0447\u0430\u0442\u044C",[r.resume]:"\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C",[r.restart]:"\u041D\u0430\u0447\u0430\u0442\u044C \u0437\u0430\u043D\u043E\u0432\u043E",[r.score]:"\u0420\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u044B",[r.settings]:"\u041D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438",[r.close]:"\u041D\u0430\u0437\u0430\u0434"};class w{constructor(e,s){o(this,"rows");o(this,"cols");o(this,"blockTypes",{I:[[0,0,0,0],["I","I","I","I"],[0,0,0,0],[0,0,0,0]],J:[["J",0,0],["J","J","J"],[0,0,0]],L:[[0,0,"L"],["L","L","L"],[0,0,0]],O:[["O","O"],["O","O"]],S:[[0,"S","S"],["S","S",0],[0,0,0]],T:[[0,"T",0],["T","T","T"],[0,0,0]],Z:[["Z","Z",0],[0,"Z","Z"],[0,0,0]]});o(this,"pointsCount",{1:100,2:300,3:700,4:1500});o(this,"status",l.new);o(this,"space",[]);o(this,"totalPoint",0);o(this,"activeItem",this.createItem());o(this,"nextItem",this.createItem());this.rows=e,this.cols=s}get speed(){const e=Math.ceil((100-this.totalPoint/100)/10)*70;return Math.max(e,100)}createSpace(e,s){const i=[];for(let t=0;t<e;t++){i.push([]);for(let a=0;a<s;a++)i[t].push(0)}return i}createItem(){const e=Object.keys(this.blockTypes),s=e[Math.floor(Math.random()*e.length)],i=this.blockTypes[s];return{x:Math.floor(10/2-i.length/2),y:-1,block:i}}lockItem(){const{x:e,y:s,block:i}=this.activeItem;for(let t=0;t<i.length;t++)for(let a=0;a<i[t].length;a++)t+s<0?this.gameOver():i[t][a]&&(this.space[t+s][a+e]=i[t][a])}blockIsOffset(){const{x:e,y:s,block:i}=this.activeItem;for(let t=0;t<i.length;t++)for(let a=0;a<i[t].length;a++)if(i[t][a]&&(this.space[s+t]===void 0||this.space[s+t][e+a]===void 0||this.space[s+t][e+a]))return!0;return!1}moveItemLeft(){this.activeItem.x-=1,this.blockIsOffset()&&(this.activeItem.x+=1)}moveItemRight(){this.activeItem.x+=1,this.blockIsOffset()&&(this.activeItem.x-=1)}moveItemDown(){this.activeItem.y+=1,this.blockIsOffset()&&(this.activeItem.y-=1,this.lockItem(),this.updateSpaceBlock(),this.clearLines())}rotateItem(){const{block:e}=this.activeItem,s=e.length,i=this.createSpace(s,s);for(let t=0;t<s;t++)for(let a=0;a<s;a++)i[a][t]=e[s-1-t][a];this.activeItem.block=i,this.blockIsOffset()&&(this.activeItem.block=e)}getPlaySpace(){this.space.length||(this.space=this.createSpace(this.rows,this.cols));const e=JSON.parse(JSON.stringify(this.space)),{x:s,y:i,block:t}=this.activeItem;return t.forEach((a,h)=>{a.forEach((c,u)=>{c&&e[i+h]&&(e[i+h][s+u]=c)})}),e}updateSpaceBlock(){this.activeItem=this.nextItem,this.nextItem=this.createItem()}clearLines(){const e=this.getPlaySpace(),s=e.length,i=e[0].length,t=[],a=new Array(10).fill(0,0);for(let c=s-1;c;c--)e[c].filter(d=>d).length===i&&t.push(c);t.forEach((c,u)=>{this.space.splice(c+u,1),this.space.unshift([...a])}),this.totalPoint+=this.pointsCount[t.length]||0;const h=Number(localStorage.getItem(m)||0);return localStorage.setItem(m,`${Math.max(this.totalPoint,h)}`),t.length&&this.clearLines(),!0}gameOver(){this.status=l.game_over}restart(){this.activeItem=this.createItem(),this.space=this.createSpace(this.rows,this.cols),this.totalPoint=0}}class y{constructor(e,s,i,t,a,h){o(this,"element");o(this,"menu");o(this,"width");o(this,"height");o(this,"rows");o(this,"cols");o(this,"context");o(this,"nextElemCanvas");o(this,"cellWidth");o(this,"itemColor",{I:"cyan",J:"blue",L:"orange",O:"yellow",S:"green",T:"purple",Z:"red"});this.element=e,this.menu=h,this.width=s,this.height=i,this.rows=t,this.cols=a;const c=document.createElement("canvas");c.width=this.width,c.height=this.height,this.element.appendChild(c),this.context=c.getContext("2d"),this.cellWidth=this.width/this.cols;const u=document.createElement("canvas");u.width=60,u.height=60,u.setAttribute("id","canvas-next"),this.element.appendChild(u),this.nextElemCanvas=u.getContext("2d")}render(e){this.clearPlaySpace(),this.renderGameSpace(e)}clearPlaySpace(){this.context.clearRect(0,0,this.width,this.height)}renderGameSpace(e){for(let s=0;s<this.rows;s++)for(let i=0;i<this.cols;i++)this.context.fillStyle=this.itemColor[e[s][i]]||"white",this.context.fillRect(i*this.cellWidth,s*this.cellWidth,this.cellWidth,this.cellWidth),this.context.strokeStyle="#fafafa",this.context.lineWidth=1,this.context.strokeRect(i*this.cellWidth,s*this.cellWidth,this.cellWidth,this.cellWidth)}renderNextItem(e){var s;for(let i=0;i<this.rows;i++)for(let t=0;t<this.cols;t++)this.nextElemCanvas.fillStyle=this.itemColor[(s=e==null?void 0:e[i])==null?void 0:s[t]]||"white",this.nextElemCanvas.fillRect(t*this.cellWidth/2,i*this.cellWidth/2,this.cellWidth/2,this.cellWidth/2),this.nextElemCanvas.strokeStyle="#fafafa",this.nextElemCanvas.lineWidth=1,this.nextElemCanvas.strokeRect(t*this.cellWidth/2,i*this.cellWidth/2,this.cellWidth/2,this.cellWidth/2)}setScore(e){const s=document.getElementById("tetris__info"),i=s.querySelector(".score");i.innerHTML=`${e}`;const t=localStorage.getItem(m),a=s.querySelector(".record");a.innerHTML=` ${t||0}`}setMenuButtons(e){const s=this.menu.querySelector(".menu__list");s.innerHTML="",e.forEach(i=>{s.insertAdjacentHTML("beforeend",`
        <li>
          <button data-status="${i}" class="menu__item">${v[i]}</button>
        </li>
      `)})}changeStatus(e){switch(e){case l.pause:this.setMenuButtons([r.resume,r.restart,r.score,r.settings]),this.menu.style.display="flex";break;case l.game_over:this.setMenuButtons([r.restart,r.score,r.settings]),this.menu.style.display="flex";break;case l.new:this.setMenuButtons([r.play,r.score,r.settings]),this.menu.style.display="flex";break;default:this.menu.style.display="none"}}showScore(e){const s=this.menu.querySelector(".menu__list");this.setMenuButtons([r.close]),s.insertAdjacentHTML("afterbegin",`
      <li>\u0412\u0430\u0448 \u043C\u0430\u043A\u0441\u0438\u043C\u0430\u043B\u044C\u043D\u043E \u043D\u0430\u0431\u0440\u0430\u043D\u043D\u044B\u0439 \u0431\u0430\u043B\u043B: ${e}</li>
    `)}showSettingMenu(){const e=this.menu.querySelector(".menu__list");this.setMenuButtons([r.close]),e.insertAdjacentHTML("afterbegin",`
      <li class="menu__item-setting">
        <label for="name">\u0418\u043C\u044F \u043F\u043E\u043B\u044C\u0437\u043E\u0432\u0430\u0442\u0435\u043B\u044F</label>
        <input id="name" value="User">
      </li>
      <li class="menu__item-setting">
        <label for="size">\u0420\u0430\u0437\u043C\u0435\u0440 \u043F\u043E\u043B\u044F</label>
        <select id="size">
          <option>\u041C\u0430\u043B\u0435\u043D\u044C\u043A\u0438\u0439 (7x14)</option>
          <option>\u0421\u0440\u0435\u0434\u043D\u0438\u0439 (10x20)</option>
          <option>\u0411\u043E\u043B\u044C\u0448\u043E\u0439 (15x30)</option>
        </select>
      </li>
      <li>
        <button class="menu__item">\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C</button>
      </li>
    `)}}class I{constructor(e,s,i){o(this,"game",{});o(this,"view",{});o(this,"menu");o(this,"gameProcess",0);o(this,"currentSpeed",0);this.game=e,this.view=s,this.menu=i,document.addEventListener("keydown",this.setKeydownListeners.bind(this)),i.addEventListener("click",this.menuClick.bind(this)),this.view.changeStatus(this.game.status)}setKeydownListeners(e){if(this.game.status===l.active)switch(e.key){case"Escape":clearInterval(this.gameProcess),this.game.status=l.pause,this.view.changeStatus(this.game.status);break;case"ArrowLeft":this.game.moveItemLeft(),this.view.render(this.game.getPlaySpace());break;case"ArrowRight":this.game.moveItemRight(),this.view.render(this.game.getPlaySpace());break;case"ArrowDown":this.game.moveItemDown(),this.view.setScore(this.game.totalPoint),this.currentSpeed!==this.game.speed&&(clearInterval(this.gameProcess),this.gameProcess=setInterval(this.playing.bind(this),this.game.speed)),Number(this.game.status)===l.game_over?(clearInterval(this.gameProcess),this.view.changeStatus(this.game.status)):(this.view.render(this.game.getPlaySpace()),this.view.renderNextItem(this.game.nextItem.block));break;case"ArrowUp":this.game.rotateItem(),this.view.render(this.game.getPlaySpace());break;default:return null}else e.key==="Enter"&&this.startGame()}menuClick(e){if(e.target.tagName.toLowerCase()==="button")switch(e.target.dataset.status){case"play":case"resume":{this.startGame();break}case"restart":{this.game.restart(),this.startGame();break}case"score":{const s=Number(localStorage.getItem(m)||0);this.view.showScore(Math.max(s,this.game.totalPoint));break}case"settings":{this.view.showSettingMenu();break}case r.close:{this.view.changeStatus(this.game.status);break}default:console.log("status",e.target.dataset.status)}}startGame(){this.view.render(this.game.getPlaySpace()),this.view.renderNextItem(this.game.nextItem.block),this.game.status===l.game_over&&this.game.restart(),this.game.status=l.active,this.view.changeStatus(this.game.status),this.playing(),this.currentSpeed=this.game.speed,this.gameProcess=setInterval(this.playing.bind(this),this.game.speed)}playing(){this.game.moveItemDown(),this.view.setScore(this.game.totalPoint),this.game.status===l.game_over?(clearInterval(this.gameProcess),this.view.changeStatus(l.game_over)):(this.view.render(this.game.getPlaySpace()),this.view.renderNextItem(this.game.nextItem.block))}}const b=document.getElementById("tetris"),g=document.getElementById("menu"),S=new w(20,10),k=new y(b,320,640,20,10,g);new I(S,k,g);
